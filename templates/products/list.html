{% extends 'base.html' %}

{% load static %}



{% block title %}Products - Listzy{% endblock %}

{% block extra_css %}
<style>
.product-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.product-card.selected {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    transform: translateY(-2px);
}

.bulk-actions-bar {
    transform: translateY(-100%);
    transition: transform 0.3s ease;
}

.bulk-actions-bar.active {
    transform: translateY(0);
}

.filter-chip {
    transition: all 0.2s ease;
}

.filter-chip.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.publishing-status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
}

.status-published { background-color: #10b981; }
.status-draft { background-color: #f59e0b; }
.status-partial { background-color: #8b5cf6; }
.status-failed { background-color: #ef4444; }
.status-none { background-color: #6b7280; }

.channel-selector {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.channel-selector.open {
    max-height: 400px;
}

.progress-bar {
    height: 4px;
    background: #e5e7eb;
    border-radius: 2px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981, #059669);
    border-radius: 2px;
    transition: width 0.3s ease;
}

@keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.3); }
    50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.6); }
}

.pulse-glow {
    animation: pulse-glow 2s infinite;
}

.publishing-modal {
    backdrop-filter: blur(8px);
}

.slide-up {
    animation: slideUp 0.4s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50">
    <!-- Bulk Actions Bar (Hidden by default) -->
    <div id="bulkActionsBar" class="bulk-actions-bar fixed top-16 left-0 right-0 bg-white border-b shadow-lg z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button id="closeBulkActions" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <span class="font-semibold text-gray-900">
                        <span id="selectedCount">0</span> products selected
                    </span>
                </div>
                
                <div class="flex items-center space-x-3">
                    <!-- Channel Selection Dropdown -->
                    <div class="relative">
                        <button id="channelSelectorBtn" 
                                class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-2 rounded-lg font-medium hover:bg-blue-100 transition-colors flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                            Select Channels
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <div id="channelSelector" class="channel-selector absolute top-full left-0 mt-2 w-80 bg-white rounded-xl shadow-lg border border-gray-200 z-50">
                            <div class="p-4">
                                <h4 class="font-semibold text-gray-900 mb-3">Choose Publishing Channels</h4>
                                
                                <!-- Quick Selection Buttons -->
                                <div class="flex space-x-2 mb-4">
                                    <button onclick="selectChannelGroup('marketplace')" 
                                            class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full hover:bg-blue-200">
                                        üõçÔ∏è Marketplaces
                                    </button>
                                    <button onclick="selectChannelGroup('social')" 
                                            class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full hover:bg-purple-200">
                                        üì± Social Media
                                    </button>
                                    <button onclick="selectChannelGroup('all')" 
                                            class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full hover:bg-green-200">
                                        ‚ú® All Channels
                                    </button>
                                </div>
                                
                                <!-- Individual Channel Checkboxes -->
                                <div id="channelList" class="space-y-2 max-h-48 overflow-y-auto">
                                    <!-- Populated by JavaScript -->
                                </div>
                                
                                <div class="flex justify-between items-center mt-4 pt-3 border-t">
                                    <span class="text-sm text-gray-500">
                                        <span id="selectedChannelCount">0</span> channels selected
                                    </span>
                                    <button onclick="closeChannelSelector()" 
                                            class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                        Done
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bulk Action Buttons -->
                    <button id="bulkPublishBtn" 
                            class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-2 rounded-lg font-medium transition-all duration-200 shadow-lg hover:shadow-xl flex items-center"
                            disabled>
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Publish Selected
                    </button>
                    
                    <button onclick="bulkDeleteProducts()" 
                            class="bg-red-50 border border-red-200 text-red-700 px-4 py-2 rounded-lg font-medium hover:bg-red-100 transition-colors">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Enhanced Header -->
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6 mb-8">
            <div>
                <h1 class="text-4xl font-bold text-gray-900 mb-2">üì¶ Your Products</h1>
                <p class="text-lg text-gray-600">Manage and publish your product catalog across all channels</p>
            </div>
            
            <div class="flex flex-wrap gap-3">
                <button id="selectAllProductsBtn" 
                        class="bg-white border-2 border-blue-500 text-blue-600 hover:bg-blue-50 px-6 py-3 rounded-xl font-medium transition-all duration-200 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Select All
                </button>
                
                <a href="{% url 'products:create' %}" 
                   class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 shadow-lg hover:shadow-xl flex items-center transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    New Product
                </a>
            </div>
        </div>

        <!-- Advanced Filters and Search -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-8 slide-up">
            <div class="flex flex-col lg:flex-row lg:items-center gap-6">
                <!-- Search Bar -->
                <div class="flex-1">
                    <div class="relative">
                        <svg class="absolute left-3 top-3 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input type="text" 
                               id="searchInput"
                               placeholder="Search products by name, SKU, or description..." 
                               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                
                <!-- Filter Chips -->
                <div class="flex flex-wrap gap-2">
                    <button class="filter-chip active bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-200" 
                            data-filter="all">
                        All Products
                    </button>
                    <button class="filter-chip bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-200" 
                            data-filter="published">
                        <span class="publishing-status-indicator status-published"></span>
                        Published
                    </button>
                    <button class="filter-chip bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-200" 
                            data-filter="draft">
                        <span class="publishing-status-indicator status-draft"></span>
                        Drafts
                    </button>
                    <button class="filter-chip bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-200" 
                            data-filter="partial">
                        <span class="publishing-status-indicator status-partial"></span>
                        Partial
                    </button>
                    <button class="filter-chip bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-200" 
                            data-filter="unpublished">
                        <span class="publishing-status-indicator status-none"></span>
                        Unpublished
                    </button>
                </div>
            </div>
            
            <!-- Advanced Filter Options -->
            <div id="advancedFilters" class="mt-4 pt-4 border-t border-gray-200 hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Price Range</label>
                        <div class="flex space-x-2">
                            <input type="number" placeholder="Min" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <input type="number" placeholder="Max" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date Created</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option>Any time</option>
                            <option>Last 7 days</option>
                            <option>Last 30 days</option>
                            <option>Last 90 days</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Channel Status</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option>All channels</option>
                            <option>Published on Shopify</option>
                            <option>Published on Etsy</option>
                            <option>Published on Instagram</option>
                            <option>Not published anywhere</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center mt-4">
                <button onclick="toggleAdvancedFilters()" 
                        class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                    </svg>
                    Advanced Filters
                </button>
                
                <div class="text-sm text-gray-500">
                    <span id="productCount">{{ page_obj.paginator.count }}</span> products found
                </div>
            </div>
        </div>

        <!-- Products Grid -->
        {% if page_obj %}
            <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
                {% for product in page_obj %}
                <div class="product-card bg-white rounded-2xl shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-300 slide-up"
                     data-product-id="{{ product.id }}"
                     data-product-name="{{ product.title|lower }}"
                     data-product-sku="{{ product.sku|lower }}"
                     data-product-price="{{ product.price }}"
                     data-publishing-status="{% if product.listings.exists %}{% if product.listings.count == connected_channels_count %}published{% else %}partial{% endif %}{% else %}unpublished{% endif %}"
                     style="animation-delay: {{ forloop.counter0|add:1 }}00ms">
                    
                    <!-- Selection Checkbox -->
                    <div class="absolute top-4 left-4 z-10">
                        <input type="checkbox" 
                               class="product-checkbox w-5 h-5 text-blue-600 bg-white border-2 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
                               data-product-id="{{ product.id }}">
                    </div>
                    
                    <!-- Product Image -->
                    <div class="relative aspect-w-1 aspect-h-1">
                        {% if product.primary_image %}
                            <img src="{{ product.primary_image.image.url }}" 
                                 alt="{{ product.title }}" 
                                 class="w-full h-56 object-cover rounded-t-2xl">
                        {% else %}
                            <div class="w-full h-56 bg-gradient-to-br from-gray-200 to-gray-300 rounded-t-2xl flex items-center justify-center">
                                <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                        {% endif %}
                        
                        <!-- Publishing Status Badge -->
                        <div class="absolute top-4 right-4">
                            {% if product.listings.exists %}
                                {% if product.listings.count == connected_channels_count %}
                                    <span class="bg-green-500 text-white px-2 py-1 rounded-full text-xs font-medium">
                                        ‚úÖ Published
                                    </span>
                                {% else %}
                                    <span class="bg-purple-500 text-white px-2 py-1 rounded-full text-xs font-medium">
                                        üìä Partial
                                    </span>
                                {% endif %}
                            {% else %}
                                <span class="bg-gray-400 text-white px-2 py-1 rounded-full text-xs font-medium">
                                    üìã Draft
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Product Info -->
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-lg font-bold text-gray-900 line-clamp-2 flex-1">{{ product.title }}</h3>
                            <span class="ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium {% if product.is_active %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                {% if product.is_active %}üü¢{% else %}‚≠ï{% endif %}
                            </span>
                        </div>
                        
                        <p class="text-gray-600 text-sm mb-4 line-clamp-2">{{ product.description|truncatewords:15 }}</p>
                        
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-2xl font-bold text-green-600">${{ product.price }}</span>
                            {% if product.sku %}
                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">{{ product.sku }}</span>
                            {% endif %}
                        </div>
                        
                        <!-- Publishing Progress -->
                        <div class="mb-4">
                            <div class="flex justify-between items-center text-xs text-gray-500 mb-1">
                                <span>Publishing Progress</span>
                                <span>{{ product.listings.count }}/{{ connected_channels_count }} channels</span>
                            </div>
                           
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="space-y-2">
                            <div class="flex space-x-2">
                                <a href="{% url 'products:detail' product.id %}" 
                                   class="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-2 rounded-xl text-sm font-medium text-center transition-colors">
                                    ‚úèÔ∏è Edit
                                </a>
                                <a href="{% url 'products:listings' product.id %}" 
                                   class="flex-1 bg-green-50 hover:bg-green-100 text-green-700 px-4 py-2 rounded-xl text-sm font-medium text-center transition-colors">
                                    üì° Publish
                                </a>
                            </div>
                            
                            <!-- Quick Publish Button -->
                            <button onclick="quickPublishProduct('{{ product.id }}')" 
                                    class="w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white px-4 py-2 rounded-xl text-sm font-medium transition-all duration-200 flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Quick Publish All
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <div class="flex justify-center">
                <nav class="flex items-center space-x-2">
                    {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}&status={{ status_filter }}" 
                           class="px-4 py-2 text-sm text-gray-500 hover:text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                            Previous
                        </a>
                    {% endif %}
                    
                    {% for page in page_obj.paginator.page_range %}
                        {% if page == page_obj.number %}
                            <span class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg">{{ page }}</span>
                        {% else %}
                            <a href="?page={{ page }}&search={{ search_query }}&status={{ status_filter }}" 
                               class="px-4 py-2 text-sm text-gray-500 hover:text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                {{ page }}
                            </a>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}&search={{ search_query }}&status={{ status_filter }}" 
                           class="px-4 py-2 text-sm text-gray-500 hover:text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                            Next
                        </a>
                    {% endif %}
                </nav>
            </div>
            {% endif %}
        {% else %}
            <!-- Enhanced Empty State -->
            <div class="text-center py-20">
                <div class="max-w-md mx-auto">
                    <div class="w-32 h-32 mx-auto mb-8 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center">
                        <svg class="w-16 h-16 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-900 mb-4">
                        {% if search_query %}No products found{% else %}Ready to start selling?{% endif %}
                    </h3>
                    <p class="text-lg text-gray-600 mb-8">
                        {% if search_query %}
                            Try adjusting your search terms or filters to find what you're looking for.
                        {% else %}
                            Create your first product and start reaching customers across all your channels.
                        {% endif %}
                    </p>
                    
                    <div class="space-y-4">
                        {% if not search_query %}
                            <a href="{% url 'products:create' %}" 
                               class="inline-flex items-center px-8 py-4 text-lg font-medium rounded-xl text-white bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 transition-all duration-200 transform hover:scale-105 shadow-lg">
                                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Create Your First Product
                            </a>
                        {% endif %}
                        
                        <div class="text-sm text-gray-500">
                            <p>üí° Tip: Connect your channels first to enable one-click publishing</p>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Bulk Publishing Modal -->
<div id="publishingModal" class="publishing-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 max-w-lg w-full mx-4 transform transition-all">
        <div class="text-center">
            <div class="w-16 h-16 mx-auto mb-4 bg-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-8 h-8 text-blue-500 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Publishing Products</h3>
            <p class="text-gray-600 mb-6" id="publishingStatus">Preparing to publish...</p>
            
            <div class="mb-6">
                <div class="progress-bar">
                    <div id="publishingProgress" class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-2">
                    <span id="currentProduct">Starting...</span>
                    <span id="progressText">0%</span>
                </div>
            </div>
            
            <div id="publishingResults" class="hidden space-y-2 mb-6 max-h-32 overflow-y-auto">
                <!-- Results will be populated here -->
            </div>
            
            <button id="closePublishingModal" onclick="closePublishingModal()" 
                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-xl font-medium transition-colors hidden">
                Done
            </button>
        </div>
    </div>
</div>

<!-- Hidden CSRF Token -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<script>
// Global variables
let selectedProducts = new Set();
let selectedChannels = new Set();
let availableChannels = [];

// Mock data for demonstration - replace with actual channel data
const mockChannels = [
    {id: 'shopify', name: 'Shopify', type: 'marketplace', icon: 'üõçÔ∏è', connected: true},
    {id: 'etsy', name: 'Etsy', type: 'marketplace', icon: 'üé®', connected: true},
    {id: 'woocommerce', name: 'WooCommerce', type: 'marketplace', icon: 'üõí', connected: false},
    {id: 'instagram', name: 'Instagram', type: 'social', icon: 'üì∏', connected: true},
    {id: 'facebook', name: 'Facebook', type: 'social', icon: 'üë•', connected: false},
    {id: 'tiktok', name: 'TikTok', type: 'social', icon: 'üéµ', connected: false}
];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeChannels();
    setupEventListeners();
    setupFilters();
    updateUI();
});

function initializeChannels() {
    availableChannels = mockChannels.filter(ch => ch.connected);
    populateChannelSelector();
}

function populateChannelSelector() {
    const channelList = document.getElementById('channelList');
    channelList.innerHTML = '';
    
    availableChannels.forEach(channel => {
        const channelItem = document.createElement('div');
        channelItem.className = 'flex items-center justify-between p-2 hover:bg-gray-50 rounded-lg';
        channelItem.innerHTML = `
            <div class="flex items-center space-x-3">
                <span class="text-lg">${channel.icon}</span>
                <div>
                    <div class="font-medium text-gray-900">${channel.name}</div>
                    <div class="text-xs text-gray-500 capitalize">${channel.type}</div>
                </div>
            </div>
            <input type="checkbox" 
                   class="channel-checkbox w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                   data-channel-id="${channel.id}"
                   onchange="updateSelectedChannels()">
        `;
        channelList.appendChild(channelItem);
    });
}

function setupEventListeners() {
    // Product selection
    document.querySelectorAll('.product-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const productId = this.dataset.productId;
            if (this.checked) {
                selectedProducts.add(productId);
                this.closest('.product-card').classList.add('selected');
            } else {
                selectedProducts.delete(productId);
                this.closest('.product-card').classList.remove('selected');
            }
            updateUI();
        });
    });
    
    // Select all products
    document.getElementById('selectAllProductsBtn').addEventListener('click', function() {
        const allCheckboxes = document.querySelectorAll('.product-checkbox');
        const allSelected = selectedProducts.size === allCheckboxes.length;
        
        if (allSelected) {
            // Deselect all
            selectedProducts.clear();
            allCheckboxes.forEach(cb => {
                cb.checked = false;
                cb.closest('.product-card').classList.remove('selected');
            });
        } else {
            // Select all
            allCheckboxes.forEach(cb => {
                cb.checked = true;
                selectedProducts.add(cb.dataset.productId);
                cb.closest('.product-card').classList.add('selected');
            });
        }
        updateUI();
    });
    
    // Close bulk actions
    document.getElementById('closeBulkActions').addEventListener('click', function() {
        selectedProducts.clear();
        document.querySelectorAll('.product-checkbox').forEach(cb => {
            cb.checked = false;
            cb.closest('.product-card').classList.remove('selected');
        });
        updateUI();
    });
    
    // Channel selector
    document.getElementById('channelSelectorBtn').addEventListener('click', function() {
        const selector = document.getElementById('channelSelector');
        selector.classList.toggle('open');
    });
    
    // Bulk publish
    document.getElementById('bulkPublishBtn').addEventListener('click', function() {
        if (selectedProducts.size === 0 || selectedChannels.size === 0) {
            showToast('Please select products and channels to publish', 'warning');
            return;
        }
        startBulkPublishing();
    });
    
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            filterProducts();
        }, 300);
    });
}

function setupFilters() {
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', function() {
            // Update active state
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            
            // Filter products
            filterProducts();
        });
    });
}

function filterProducts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const activeFilter = document.querySelector('.filter-chip.active').dataset.filter;
    const productCards = document.querySelectorAll('.product-card');
    let visibleCount = 0;
    
    productCards.forEach(card => {
        const name = card.dataset.productName;
        const sku = card.dataset.productSku;
        const status = card.dataset.publishingStatus;
        
        // Search filter
        const matchesSearch = !searchTerm || 
            name.includes(searchTerm) || 
            sku.includes(searchTerm);
        
        // Status filter
        const matchesStatus = activeFilter === 'all' || status === activeFilter;
        
        if (matchesSearch && matchesStatus) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Update count
    document.getElementById('productCount').textContent = visibleCount;
}

function updateUI() {
    const bulkBar = document.getElementById('bulkActionsBar');
    const selectedCount = selectedProducts.size;
    const publishBtn = document.getElementById('bulkPublishBtn');
    const selectAllBtn = document.getElementById('selectAllProductsBtn');
    
    // Show/hide bulk actions bar
    if (selectedCount > 0) {
        bulkBar.classList.add('active');
        document.body.style.paddingTop = '80px';
    } else {
        bulkBar.classList.remove('active');
        document.body.style.paddingTop = '0';
    }
    
    // Update selected count
    document.getElementById('selectedCount').textContent = selectedCount;
    
    // Update publish button state
    publishBtn.disabled = selectedCount === 0 || selectedChannels.size === 0;
    publishBtn.classList.toggle('opacity-50', publishBtn.disabled);
    
    // Update select all button
    const totalProducts = document.querySelectorAll('.product-checkbox').length;
    selectAllBtn.innerHTML = selectedCount === totalProducts && totalProducts > 0 ? 
        `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>Clear All` :
        `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>Select All`;
}

function updateSelectedChannels() {
    selectedChannels.clear();
    document.querySelectorAll('.channel-checkbox:checked').forEach(cb => {
        selectedChannels.add(cb.dataset.channelId);
    });
    
    const count = selectedChannels.size;
    document.getElementById('selectedChannelCount').textContent = count;
    
    // Update publish button
    const publishBtn = document.getElementById('bulkPublishBtn');
    publishBtn.disabled = selectedProducts.size === 0 || selectedChannels.size === 0;
    publishBtn.classList.toggle('opacity-50', publishBtn.disabled);
    
    // Update button text
    if (count > 0) {
        publishBtn.innerHTML = `
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            Publish to ${count} Channel${count !== 1 ? 's' : ''}
        `;
    } else {
        publishBtn.innerHTML = `
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            Publish Selected
        `;
    }
}

function selectChannelGroup(type) {
    document.querySelectorAll('.channel-checkbox').forEach(cb => {
        const channelId = cb.dataset.channelId;
        const channel = availableChannels.find(ch => ch.id === channelId);
        
        if (type === 'all') {
            cb.checked = true;
        } else if (type === 'marketplace' && channel.type === 'marketplace') {
            cb.checked = true;
        } else if (type === 'social' && channel.type === 'social') {
            cb.checked = true;
        } else {
            cb.checked = false;
        }
    });
    
    updateSelectedChannels();
    showToast(`${type === 'all' ? 'All' : type === 'marketplace' ? 'Marketplace' : 'Social media'} channels selected`, 'success');
}

function closeChannelSelector() {
    document.getElementById('channelSelector').classList.remove('open');
}

async function startBulkPublishing() {
    const modal = document.getElementById('publishingModal');
    const progressBar = document.getElementById('publishingProgress');
    const statusText = document.getElementById('publishingStatus');
    const currentProductText = document.getElementById('currentProduct');
    const progressText = document.getElementById('progressText');
    const resultsContainer = document.getElementById('publishingResults');
    const closeBtn = document.getElementById('closePublishingModal');
    
    // Show modal
    modal.classList.remove('hidden');
    resultsContainer.classList.add('hidden');
    closeBtn.classList.add('hidden');
    
    const products = Array.from(selectedProducts);
    const channels = Array.from(selectedChannels);
    const totalOperations = products.length * channels.length;
    let completedOperations = 0;
    let successCount = 0;
    let results = [];
    
    statusText.textContent = `Publishing ${products.length} products to ${channels.length} channels...`;
    
    for (const productId of products) {
        const productCard = document.querySelector(`[data-product-id="${productId}"]`);
        const productName = productCard ? productCard.querySelector('h3').textContent : `Product ${productId}`;
        
        currentProductText.textContent = `Publishing: ${productName}`;
        
        for (const channelId of channels) {
            const channel = availableChannels.find(ch => ch.id === channelId);
            
            try {
                // Simulate API call - replace with actual implementation
                const response = await fetch(`/products/${productId}/publish/${channelId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    successCount++;
                    results.push({
                        product: productName,
                        channel: channel.name,
                        success: true,
                        message: 'Published successfully'
                    });
                } else {
                    results.push({
                        product: productName,
                        channel: channel.name,
                        success: false,
                        message: data.message || 'Publishing failed'
                    });
                }
                
            } catch (error) {
                results.push({
                    product: productName,
                    channel: channel.name,
                    success: false,
                    message: 'Network error'
                });
            }
            
            completedOperations++;
            const progress = (completedOperations / totalOperations) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${Math.round(progress)}%`;
            
            // Small delay to show progress
            await new Promise(resolve => setTimeout(resolve, 100));
        }
    }
    
    // Show results
    statusText.textContent = `Complete! ${successCount}/${totalOperations} operations successful`;
    currentProductText.textContent = 'Finished';
    
    // Display detailed results
    resultsContainer.innerHTML = results.map(result => `
        <div class="flex items-center justify-between p-2 rounded ${result.success ? 'bg-green-50' : 'bg-red-50'}">
            <div class="flex items-center space-x-2">
                <span class="${result.success ? 'text-green-500' : 'text-red-500'}">${result.success ? '‚úÖ' : '‚ùå'}</span>
                <span class="text-sm">${result.product} ‚Üí ${result.channel}</span>
            </div>
            ${!result.success ? `<span class="text-xs text-red-600">${result.message}</span>` : ''}
        </div>
    `).join('');
    
    resultsContainer.classList.remove('hidden');
    closeBtn.classList.remove('hidden');
    
    // Show summary toast
    if (successCount > 0) {
        showToast(`üéâ Successfully published ${successCount} listings!`, 'success');
    }
    
    // Auto-refresh page after delay
    setTimeout(() => {
        location.reload();
    }, 3000);
}

async function quickPublishProduct(productId) {
    if (availableChannels.length === 0) {
        showToast('No channels connected. Connect channels first.', 'warning');
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = `
        <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Publishing...
    `;
    
    try {
        const response = await fetch(`/products/${productId}/publish-all/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            
            // Update product card status
            const card = button.closest('.product-card');
            const statusBadge = card.querySelector('.absolute.top-4.right-4 span');
            if (statusBadge) {
                statusBadge.className = 'bg-green-500 text-white px-2 py-1 rounded-full text-xs font-medium';
                statusBadge.textContent = '‚úÖ Published';
            }
            
            // Update progress bar
            const progressBar = card.querySelector('.progress-fill');
            if (progressBar) {
                progressBar.style.width = '100%';
            }
            
        } else {
            showToast(data.message, 'error');
        }
        
    } catch (error) {
        showToast('Publishing failed. Please try again.', 'error');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

function bulkDeleteProducts() {
    if (selectedProducts.size === 0) {
        showToast('Please select products to delete', 'warning');
        return;
    }
    
    if (confirm(`Are you sure you want to delete ${selectedProducts.size} product${selectedProducts.size !== 1 ? 's' : ''}? This action cannot be undone.`)) {
        // Implement bulk delete functionality
        showToast(`${selectedProducts.size} products deleted`, 'success');
        
        // Remove from UI
        selectedProducts.forEach(productId => {
            const card = document.querySelector(`[data-product-id="${productId}"]`);
            if (card) card.remove();
        });
        
        selectedProducts.clear();
        updateUI();
    }
}

function toggleAdvancedFilters() {
    const filters = document.getElementById('advancedFilters');
    filters.classList.toggle('hidden');
}

function closePublishingModal() {
    document.getElementById('publishingModal').classList.add('hidden');
}

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = 'transform transition-all duration-300 translate-x-full';
    
    const bgColor = {
        'success': 'bg-green-500',
        'error': 'bg-red-500',
        'warning': 'bg-yellow-500',
        'info': 'bg-blue-500'
    }[type] || 'bg-blue-500';
    
    const icon = {
        'success': '‚úÖ',
        'error': '‚ùå',
        'warning': '‚ö†Ô∏è',
        'info': '‚ÑπÔ∏è'
    }[type] || '‚ÑπÔ∏è';
    
    toast.innerHTML = `
        <div class="${bgColor} text-white px-6 py-4 rounded-xl shadow-lg flex items-center space-x-3 min-w-80">
            <span class="text-lg">${icon}</span>
            <span class="font-medium">${message}</span>
            <button onclick="this.closest('.transform').remove()" class="ml-4 text-white hover:text-gray-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
        toast.classList.add('translate-x-0');
    }, 100);
    
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 5000);
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'fixed top-4 right-4 z-50 space-y-2';
    document.body.appendChild(container);
    return container;
}

function getCSRFToken() {
    let token = document.querySelector('[name=csrfmiddlewaretoken]');
    if (token) return token.value;
    
    token = document.querySelector('meta[name="csrf-token"]');
    if (token) return token.getAttribute('content');
    
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') return value;
    }
    return '';
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    const channelSelector = document.getElementById('channelSelector');
    const channelBtn = document.getElementById('channelSelectorBtn');
    
    if (!channelSelector.contains(event.target) && !channelBtn.contains(event.target)) {
        channelSelector.classList.remove('open');
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closePublishingModal();
        document.getElementById('channelSelector').classList.remove('open');
    }
    
    if (event.ctrlKey || event.metaKey) {
        if (event.key === 'a') {
            event.preventDefault();
            document.getElementById('selectAllProductsBtn').click();
        }
    }
});
</script>
{% endblock %}